### 1. 表结构设计（MySQL示例）

#### 新闻元数据表 (`news_metadata`)



```sql
CREATE TABLE news_metadata (
  news_id VARCHAR(255) NOT NULL,
  title VARCHAR(500) NOT NULL,
  content LONGTEXT,
  category ENUM('sports','news','autos','foodanddrink','finance','music','lifestyle','weather','health','video','movies','tv','travel','entertainment','kids','europe','northamerica','adexperience') NOT NULL,
  title_length SMALLINT UNSIGNED NOT NULL,
  content_length MEDIUMINT UNSIGNED NOT NULL,
  create_time DATETIME NOT NULL,
  PRIMARY KEY (news_id),
  INDEX idx_category (category),
  INDEX idx_title_length (title_length),
  INDEX idx_create_time (create_time)
) ENGINE=InnoDB;
```

#### 用户行为表 (`user_behavior`)



```sql
CREATE TABLE user_behavior (
  event_id VARCHAR(255) NOT NULL,
  user_id VARCHAR(255) NOT NULL,
  news_id VARCHAR(255) NOT NULL,
  event_type ENUM('IMPRESSION','CLICK') NOT NULL,
  event_time DATETIME(6) NOT NULL,  -- 支持毫秒级精度
  PRIMARY KEY (event_id, event_time), -- 复合主键用于分区
  INDEX idx_user_time (user_id, event_time),
  INDEX idx_news_time (news_id, event_time),
  INDEX idx_event_time (event_time)
) ENGINE=InnoDB
PARTITION BY RANGE (TO_DAYS(event_time)) (
  PARTITION p202306 VALUES LESS THAN (TO_DAYS('2023-07-01')),
  PARTITION p202307 VALUES LESS THAN (TO_DAYS('2023-08-01'))
);
```

#### 新闻生命周期聚合表 (`news_lifecycle_agg`)



```sql
CREATE TABLE news_lifecycle_agg (
  agg_id INT UNSIGNED NOT NULL AUTO_INCREMENT,
  news_id VARCHAR(255) NOT NULL,
  time_slot DATETIME NOT NULL, -- 每小时或每天
  impressions INT UNSIGNED DEFAULT 0,
  clicks INT UNSIGNED DEFAULT 0,
  ctr FLOAT DEFAULT 0,
  PRIMARY KEY (agg_id),
  UNIQUE INDEX uniq_news_time (news_id, time_slot), -- 唯一索引避免重复
  INDEX idx_time_slot (time_slot)
) ENGINE=InnoDB;
```

#### 用户兴趣画像表 (`user_interest_profile`)



```sql
CREATE TABLE user_interest_profile (
  user_id VARCHAR(255) NOT NULL PRIMARY KEY,
  preferred_categories JSON NOT NULL,
  last_updated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_last_updated (last_updated)
) ENGINE=InnoDB;

-- MySQL 8.0+ 支持JSON索引
ALTER TABLE user_interest_profile 
  ADD COLUMN top_category VARCHAR(50) 
    GENERATED ALWAYS AS (JSON_UNQUOTE(JSON_EXTRACT(preferred_categories, '$.top_category'))) STORED,
  ADD INDEX idx_top_category (top_category);
```

### 2. 性能优化关键措施

#### (1) 分区策略（核心优化）



```sql
-- 每月自动创建新分区（MySQL）
DELIMITER $$
CREATE PROCEDURE create_next_partition()
BEGIN
  SET @next_month = DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 1 MONTH), '%Y%m');
  SET @sql = CONCAT(
    'ALTER TABLE user_behavior ADD PARTITION (PARTITION p', 
    @next_month, 
    ' VALUES LESS THAN (TO_DAYS("', 
    DATE_FORMAT(DATE_ADD(LAST_DAY(NOW()), INTERVAL 1 DAY), '%Y-%m-%d'),
    '")))');
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
END$$
DELIMITER ;

-- 创建事件每月执行
CREATE EVENT create_partitions_event
ON SCHEDULE EVERY 1 MONTH
STARTS TIMESTAMP(DATE_ADD(LAST_DAY(NOW()), INTERVAL 1 DAY))
DO CALL create_next_partition();
```

#### (2) 索引优化策略

| 查询类型     | 索引方案                 | 示例                                         |
| :----------- | :----------------------- | :------------------------------------------- |
| 时间范围查询 | `(event_time)` + 分区    | `WHERE event_time BETWEEN...`                |
| 用户行为分析 | `(user_id, event_time)`  | `WHERE user_id=? ORDER BY event_time`        |
| 新闻生命周期 | `(news_id, time_slot)`   | `WHERE news_id=? AND time_slot BETWEEN...`   |
| 分类统计     | `(category, event_time)` | `WHERE category=? GROUP BY DATE(event_time)` |

#### (3) 预聚合更新机制



```sql
-- 每小时更新聚合表（使用事件调度）
CREATE EVENT update_agg_table
ON SCHEDULE EVERY 1 HOUR
DO
BEGIN
  INSERT INTO news_lifecycle_agg (news_id, time_slot, impressions, clicks, ctr)
  SELECT 
    news_id,
    DATE_FORMAT(event_time, '%Y-%m-%d %H:00:00'),
    COUNT(IF(event_type='IMPRESSION', 1, NULL)),
    COUNT(IF(event_type='CLICK', 1, NULL)),
    COUNT(IF(event_type='CLICK', 1, NULL)) / COUNT(*)
  FROM user_behavior
  WHERE event_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
  GROUP BY news_id, DATE_FORMAT(event_time, '%Y-%m-%d %H:00:00')
  ON DUPLICATE KEY UPDATE
    impressions = VALUES(impressions),
    clicks = VALUES(clicks),
    ctr = VALUES(ctr);
END
```

### 3. 关键查询优化实现

#### 评分点2.1：新闻生命周期（1s响应）



```sql
SELECT 
  time_slot AS period,
  impressions,
  clicks,
  ctr
FROM news_lifecycle_agg FORCE INDEX (uniq_news_time)
WHERE news_id = 'N12345'
  AND time_slot BETWEEN '2023-06-01 00:00:00' AND '2023-06-30 23:59:59'
ORDER BY time_slot;
```

**优化点**：

- 使用预聚合表避免全表扫描
- `FORCE INDEX`确保使用最优索引
- 时间范围限制减少扫描行数

#### 评分点2.2：分类变化统计（1s响应）



```sql
SELECT
  DATE(event_time) AS day,
  category,
  COUNT(IF(event_type='IMPRESSION', 1, NULL)) AS imp,
  COUNT(IF(event_type='CLICK', 1, NULL)) AS clk
FROM user_behavior
USE INDEX (idx_event_time)
JOIN news_metadata USING (news_id)
WHERE event_time BETWEEN '2023-06-01' AND '2023-06-30'
  AND category IN ('politics', 'tech')
GROUP BY day, category;
```

**优化点**：

- 利用分区裁剪（仅扫描6月分区）
- 覆盖索引减少IO
- 避免SELECT * 只取必要字段

#### 评分点2.6：实时推荐（500ms响应）



```sql
SELECT 
  n.news_id, 
  n.title
FROM news_metadata n
WHERE n.category = (
  SELECT top_category 
  FROM user_interest_profile 
  WHERE user_id = 'U456'
)
AND NOT EXISTS (
  SELECT 1 
  FROM user_behavior 
  WHERE user_id = 'U456' 
    AND news_id = n.news_id
    AND event_type = 'CLICK'
)
ORDER BY n.create_time DESC
LIMIT 10;
```

**优化点**：

- 使用子查询避免JOIN
- EXISTS代替NOT IN（更高效）
- 索引覆盖(top_category, create_time)